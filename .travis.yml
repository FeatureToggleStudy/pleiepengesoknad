language: node_js
node_js:
- 10.2.1
before_install:
- openssl aes-256-cbc -K $encrypted_d0045aba1dea_key -iv $encrypted_d0045aba1dea_iv
  -in travis/helseci.key.enc -out travis/helseci.key -d
- git clone https://github.com/navikt/github-apps-support.git
- export PATH=`pwd`/github-apps-support/bin:$PATH
- export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
  $GITHUB_APP_ID`)
- export COMMIT_SHORT=$(git rev-parse --short HEAD)
- export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
- echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
install:
- npm install
before_script:
- npm test
script:
- npm run build
- docker build . -t navikt/pleiepengesoknad:$COMMIT_SHORT
- |
  set -e
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
    echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    docker push $DOCKER_IMG_NAME:$COMMIT_SHORT
    git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git
    cd helse-iac
    ./set-image.sh preprod/$APP_NAME/naiserator-sbs.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT
    ./set-image.sh prod/$APP_NAME/naiserator-sbs.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT
    git config user.name team-helse[bot]
    git config user.email team-helse[bot]@users.noreply.github.com
    git add preprod/$APP_NAME/naiserator-sbs.yaml
    git add prod/$APP_NAME/naiserator-sbs.yaml
    git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"
    git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master
    cd ..
    fi
env:
  global:
  - APP_NAME=pleiepengesoknad
  - DOCKER_IMG_NAME=navikt/pleiepengesoknad
  - GITHUB_APP_ID=19726
  - secure: MWQDKMM27RPXUUf7mEacLIi6x99jQ9SiqoESHSN616AvNKTczw3BB8bHbOdhSI3Uhw/RoFqGfzSmb6tpYc5jTgU8wrKm3lD+NNwG0bt56PVVIcDHljcjiBuKhoPMSovSIouNdf8/ODpftCtKzUbX+hsX3/ecn3/o+YTqdUO+GCq3+Z1eEw8fQ/byGQ/UZ3ir2ZWyan9flWzT2wyjhhkLceYy//ST/xNOqZmu96nX+2eFSMPv7P/9pQv/4C0Bdhd80sAv9l3AJ3IJ7aMfh39IDA34UVO8lDIEozwmUabes5FMFsOsCkMelFZZBYU1SzPoIvkZ8JV5knELxgoo5PMevmpHqQyXBoS7m/LrAavm8Z12OQ975WzLbatALOHJxkdUlPENhdpXr2nLnvA0J8l0x9+mm6iy07VfgmvfObX1j+LuT1PfoeNTcINjHIlH58NMPKHnTueU04b7Lr6L3+qSrmBX4SsSJA3qw/Auwf9uWgU1unmU92PtIy8KTCeK+Rqb9GImVa7afGbYt4jgOQLJRG770In6eVNozdGAFVKMHteEBDmvneZlfYpFEV6UcXprw9iXL21MzGru1Ki6l3KEb2hYt9ubBc7RZyU6fKAcZyrM0+NKPz7Enga2RvTD61VS3az2FNX/7od8QPtSyerM+dEPNhQqFOnJoVVAvMhYnOA=
  - secure: IFEgEbo2gRbnstIP/Jyberxs4KGoMIrdkm6PA0tSQfT24/MOU4G4DtjNZZ+3ixVs+fqh7zOxkR8ICowjcBOydB43ByTdqQfQdjzbMqk7kY+4wPHAsVs238XS4sVNdbQw+WHky3jV+P84vICI26KmqfJngvRXiuwstsS4LjJmIH7xXS2nV455nlBKl/c4Ts5Tu3i+EzoZjKc+/IcJecDF41XRH0MTlP36E53GiPST6Pg8YiI94zfBsP+4xehbfVVP35K0jgF0zmphAtqEuRWsDDx1RP+jqRetCpLFkV9uOkjZTxYvmp15ISJwyEPQVAvHztcbhUEzAGXRUinodGgvnRGsO1pJjjoyfcAeoY69XFp8n4R8WgUcqPZKUIrOz7tu8EUcMk6VoAgdLiWD0Ps39Ek6B58nZhQdl9AWivG5XBg+xjExstLieO65u1IK53sEAeprS2iK0N5ctHigTkXV63bdeYBP3qr9fYMEF9vel34znLiGEK8NEDCBPlXav7tNx9L6U4bhkctDfvXoj4j2kXHInX/FfeHNBNPnYHQoaQSsYFwZEnJ7os5zxdQmqne0sLg+NZh8ZUIkXn/DwpZHP9G4D2MjhaGjf1Nze/go+10Sq4bS5sDVWoJr4ltagF62mrXvjhKPiSpIjmHSOhPTtpVmW3eu+jaZUll03oHgPBE=
branches:
  only:
    - master
